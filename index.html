<!DOCTYPE html>

<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Onze Agenda &#8211; Rob &amp; Lizet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg:           #fdf8ee;
      --surface:      #f5edda;
      --card:         #ede0c4;
      --rob:          #1a5fa8;
      --rob-bg:       rgba(26,95,168,0.08);
      --rob-border:   rgba(26,95,168,0.30);
      --lizet:        #8b5e3c;
      --lizet-bg:     rgba(139,94,60,0.08);
      --lizet-border: rgba(139,94,60,0.30);
      --beide:        #3a6b4a;
      --beide-bg:     rgba(58,107,74,0.08);
      --beide-border: rgba(58,107,74,0.30);
      --text:         #1c1917;
      --muted:        #78716c;
      --border:       rgba(0,0,0,0.10);
      --green:        #2d7a46;
      --yellow:       #b45309;
      --red:          #dc2626;
      --shadow:       rgba(0,0,0,0.08);
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    html,body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; -webkit-tap-highlight-color:transparent; }
    #app { max-width:720px; margin:0 auto; padding:36px 20px 80px; }

```
/* â”€â”€ Sync bar â”€â”€ */
#sync-bar { display:none; align-items:center; gap:10px; background:rgba(58,107,74,0.08); border:1px solid rgba(58,107,74,0.25); border-radius:12px; padding:10px 14px; margin-bottom:20px; font-size:0.82rem; color:var(--beide); }
#sync-bar.error { background:rgba(220,38,38,.07); border-color:rgba(220,38,38,.25); color:var(--red); }
.sync-dot { width:8px; height:8px; border-radius:50%; background:var(--beide); flex-shrink:0; animation:pulse 2s infinite; }
#sync-bar.error .sync-dot { background:var(--red); animation:none; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

/* â”€â”€ Notification banner â”€â”€ */
#notif-banner { display:none; align-items:center; gap:12px; background:var(--rob-bg); border:1px solid var(--rob-border); border-radius:14px; padding:14px 16px; margin-bottom:28px; }
#notif-banner p { flex:1; font-size:0.83rem; color:var(--text); line-height:1.45; }
#notif-banner p strong { display:block; margin-bottom:2px; color:var(--rob); }
#notif-allow-btn { background:var(--rob-bg); border:1px solid var(--rob-border); color:var(--rob); border-radius:8px; padding:8px 14px; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; transition:all .2s; }
#notif-allow-btn:hover { background:rgba(26,95,168,.15); }
#notif-dismiss { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1.1rem; flex-shrink:0; padding:0 2px; }

/* â”€â”€ Toast â”€â”€ */
#toast { display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--text); border-radius:12px; padding:12px 20px; font-size:0.85rem; color:var(--bg); box-shadow:0 8px 32px rgba(0,0,0,.18); z-index:999; white-space:nowrap; animation:toastIn .3s ease; }
@keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(-8px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }

/* â”€â”€ Header â”€â”€ */
.header { text-align:center; margin-bottom:48px; }
.header h1 { font-family:'Playfair Display',serif; font-size:2.6rem; letter-spacing:-0.5px; background:linear-gradient(135deg,var(--rob) 0%,var(--lizet) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:10px; }
.header-names { display:flex; justify-content:center; gap:14px; margin-bottom:8px; }
.name-pill { padding:4px 16px; border-radius:20px; font-size:0.8rem; font-weight:600; }
.name-pill.rob   { background:var(--rob-bg);   border:1px solid var(--rob-border);   color:var(--rob); }
.name-pill.lizet { background:var(--lizet-bg); border:1px solid var(--lizet-border); color:var(--lizet); }
.header p { color:var(--muted); font-size:0.85rem; font-weight:300; }

/* â”€â”€ Mic section â”€â”€ */
.mic-section { display:flex; flex-direction:column; align-items:center; gap:18px; margin-bottom:40px; }
.mic-ring { position:relative; width:100px; height:100px; flex-shrink:0; }
.mic-ring::before { content:''; position:absolute; inset:-6px; border-radius:50%; background:conic-gradient(var(--rob),var(--lizet),var(--rob)); opacity:0; transition:opacity 0.4s; }
.mic-ring.listening::before { opacity:1; animation:ringRotate 2s linear infinite; }
.mic-ring::after { content:''; position:absolute; inset:-3px; border-radius:50%; background:var(--bg); opacity:0; transition:opacity 0.4s; }
.mic-ring.listening::after { opacity:1; }
@keyframes ringRotate { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
#mic-btn { position:relative; z-index:1; width:100px; height:100px; border-radius:50%; border:2px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:2rem; background:var(--surface); box-shadow:0 2px 12px var(--shadow); transition:all 0.3s ease; -webkit-appearance:none; }
#mic-btn:hover  { transform:scale(1.05); border-color:var(--rob); }
#mic-btn.active { background:linear-gradient(135deg,var(--rob-bg),var(--lizet-bg)); border-color:transparent; box-shadow:0 0 30px rgba(26,95,168,.15); }
#mic-btn.busy   { background:var(--beide-bg); border-color:var(--beide); animation:spinGlow 1.5s infinite; }
@keyframes spinGlow { 0%,100%{box-shadow:0 0 20px rgba(58,107,74,.2)} 50%{box-shadow:0 0 40px rgba(58,107,74,.4)} }
#status-text { font-size:0.85rem; color:var(--muted); text-align:center; min-height:20px; transition:color .3s; }
#status-text.active     { color:var(--rob); }
#status-text.processing { color:var(--beide); }
#transcript-box { display:none; width:100%; background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:14px 18px; font-size:0.93rem; font-style:italic; color:var(--text); line-height:1.5; }
.alert { display:none; width:100%; border-radius:12px; padding:13px 16px; font-size:0.83rem; line-height:1.55; }
.alert.error { background:rgba(220,38,38,.07); border:1px solid rgba(220,38,38,.2); color:var(--red); text-align:center; }
.alert.warn  { background:rgba(180,83,9,.07); border:1px solid rgba(180,83,9,.2); color:var(--yellow); }
.alert.warn strong { font-weight:600; display:block; margin-bottom:4px; }
#text-section { display:none; width:100%; flex-direction:column; gap:10px; }
#text-section.visible { display:flex; animation:slideIn .3s ease; }
#text-hint { font-size:0.8rem; color:var(--muted); text-align:center; }
.text-row { display:flex; gap:8px; }
#text-input { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; transition:border-color .2s; -webkit-appearance:none; box-shadow:inset 0 1px 3px var(--shadow); }
#text-input::placeholder { color:var(--muted); }
#text-input:focus { border-color:var(--rob); }
#text-submit { background:var(--rob-bg); border:1px solid var(--rob-border); color:var(--rob); border-radius:12px; padding:12px 18px; font-family:'DM Sans',sans-serif; font-size:1.1rem; cursor:pointer; transition:all .2s; flex-shrink:0; }
#text-submit:hover   { background:rgba(26,95,168,.15); }
#text-submit:disabled{ opacity:.4; cursor:not-allowed; }
.mode-toggle { font-size:0.78rem; color:var(--muted); cursor:pointer; text-decoration:underline; text-underline-offset:3px; background:none; border:none; font-family:'DM Sans',sans-serif; padding:0; }
.mode-toggle:hover { color:var(--text); }

/* â”€â”€ Camera scan button â”€â”€ */
.scan-section { display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:4px; }
#scan-btn { display:flex; align-items:center; gap:8px; background:var(--lizet-bg); border:1px solid var(--lizet-border); color:var(--lizet); border-radius:12px; padding:10px 20px; font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:600; cursor:pointer; transition:all .2s; -webkit-appearance:none; }
#scan-btn:hover { background:rgba(139,94,60,.15); transform:translateY(-1px); }
#scan-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; }
#scan-label { font-size:0.75rem; color:var(--muted); text-align:center; }
#camera-input { display:none; }

/* â”€â”€ Scan preview â”€â”€ */
#scan-preview { display:none; width:100%; flex-direction:column; align-items:center; gap:12px; }
#scan-preview.visible { display:flex; animation:slideIn .3s ease; }
#preview-img { max-width:100%; max-height:200px; border-radius:12px; border:2px solid var(--lizet-border); object-fit:contain; box-shadow:0 4px 16px var(--shadow); }
#scan-status { font-size:0.82rem; color:var(--muted); text-align:center; }
#scan-status.scanning { color:var(--lizet); }

/* â”€â”€ Tabs â”€â”€ */
.tabs { display:flex; gap:6px; margin-bottom:16px; background:var(--surface); border-radius:14px; padding:5px; border:1px solid var(--border); box-shadow:0 1px 4px var(--shadow); }
.tab { flex:1; padding:10px 8px; border:1px solid transparent; border-radius:10px; cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.875rem; font-weight:500; background:transparent; color:var(--muted); transition:all .22s; }
.tab:hover { color:var(--text); }
.tab[data-tab="alle"].active  { background:var(--bg); color:var(--text);   border-color:var(--border); box-shadow:0 1px 4px var(--shadow); }
.tab[data-tab="rob"].active   { background:var(--rob-bg);   color:var(--rob);   border-color:var(--rob-border); }
.tab[data-tab="lizet"].active { background:var(--lizet-bg); color:var(--lizet); border-color:var(--lizet-border); }

/* â”€â”€ Search bar â”€â”€ */
#search-wrap { position:relative; margin-bottom:16px; }
#search-input { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:11px 38px 11px 40px; font-family:'DM Sans',sans-serif; font-size:0.9rem; color:var(--text); outline:none; transition:border-color .2s; -webkit-appearance:none; box-shadow:0 1px 4px var(--shadow); }
#search-input::placeholder { color:var(--muted); }
#search-input:focus { border-color:var(--rob); }
#search-icon { position:absolute; left:13px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.95rem; pointer-events:none; line-height:1; }
#search-clear { display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--muted); cursor:pointer; font-size:0.85rem; padding:4px 6px; border-radius:6px; }
#search-clear:hover { color:var(--text); }
#search-count { display:none; font-size:0.75rem; color:var(--muted); text-align:right; margin-top:-10px; margin-bottom:10px; }
mark { background:rgba(180,83,9,0.20); color:var(--text); border-radius:2px; padding:0 2px; font-weight:600; }

/* â”€â”€ Export bar â”€â”€ */
#export-bar { display:none; align-items:center; justify-content:space-between; gap:12px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 16px; margin-bottom:16px; box-shadow:0 1px 4px var(--shadow); }
#export-bar p { font-size:0.82rem; color:var(--muted); line-height:1.4; }
#export-all-btn { background:var(--rob-bg); border:1px solid var(--rob-border); color:var(--rob); border-radius:8px; padding:8px 14px; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; transition:all .2s; }
#export-all-btn:hover { background:rgba(26,95,168,.15); transform:translateY(-1px); }

/* â”€â”€ Appointment cards â”€â”€ */
#apt-list { display:flex; flex-direction:column; gap:8px; }
.section-title { font-size:0.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin:24px 0 10px; display:flex; align-items:center; gap:10px; }
.section-title::after { content:''; flex:1; height:1px; background:var(--border); }
.count-badge { background:var(--card); border-radius:20px; padding:1px 9px; font-size:.75rem; font-weight:600; color:var(--muted); }
.apt-card { border-radius:14px; padding:16px 18px; display:flex; align-items:flex-start; gap:14px; border:1px solid; transition:transform .2s,box-shadow .2s; animation:slideIn .3s ease; box-shadow:0 2px 8px var(--shadow); }
.apt-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.12); }
.apt-card.rob   { background:#eaf0fb; border-color:var(--rob-border); }
.apt-card.lizet { background:#fdf5e4; border-color:var(--lizet-border); }
.apt-card.beide { background:#eaf5ec; border-color:var(--beide-border); }
@keyframes slideIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.apt-icon { font-size:1.3rem; flex-shrink:0; margin-top:2px; }
.apt-body { flex:1; min-width:0; }
.apt-who { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; margin-bottom:4px; }
.apt-who.rob   { color:var(--rob); }
.apt-who.lizet { color:var(--lizet); }
.apt-who.beide { color:var(--beide); }
.apt-desc { font-size:.975rem; font-weight:500; margin-bottom:6px; line-height:1.4; color:var(--text); }
.apt-meta { font-size:.78rem; color:var(--muted); display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
.reminder-badge { display:inline-flex; align-items:center; gap:4px; background:rgba(180,83,9,0.10); border:1px solid rgba(180,83,9,0.25); color:var(--yellow); border-radius:20px; padding:1px 8px; font-size:.72rem; font-weight:600; }
.apt-actions { display:flex; gap:4px; flex-shrink:0; align-items:flex-start; position:relative; }
.apt-cal-btn,.apt-del-btn,.apt-bell-btn { background:none; border:none; cursor:pointer; font-size:.95rem; padding:4px 6px; border-radius:6px; transition:all .2s; opacity:.3; color:var(--muted); }
.apt-card:hover .apt-cal-btn,
.apt-card:hover .apt-del-btn,
.apt-card:hover .apt-bell-btn { opacity:1; }
.apt-cal-btn:hover  { background:var(--rob-bg); color:var(--rob); }
.apt-cal-btn.done   { color:var(--green); opacity:1 !important; }
.apt-del-btn:hover  { background:rgba(220,38,38,.08); color:var(--red); }
.apt-bell-btn:hover { background:rgba(180,83,9,.08); color:var(--yellow); }
.apt-bell-btn.set   { color:var(--yellow); opacity:1 !important; }

/* â”€â”€ Reminder popover â”€â”€ */
.reminder-popover { display:none; position:absolute; top:calc(100% + 6px); right:0; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:8px; z-index:100; min-width:200px; box-shadow:0 8px 24px rgba(0,0,0,.15); animation:slideIn .15s ease; }
.reminder-popover.open { display:block; }
.reminder-popover p { font-size:0.75rem; color:var(--muted); padding:4px 8px 6px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; }
.reminder-opt { display:block; width:100%; text-align:left; background:none; border:none; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.85rem; padding:8px 10px; border-radius:8px; cursor:pointer; transition:background .15s; white-space:nowrap; }
.reminder-opt:hover  { background:var(--surface); }
.reminder-opt.active { color:var(--yellow); background:rgba(180,83,9,.07); font-weight:600; }
.reminder-opt.cancel { color:var(--red); }
.reminder-opt.cancel:hover { background:rgba(220,38,38,.07); }

/* â”€â”€ Empty / footer â”€â”€ */
.empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
.empty-state .icon { font-size:2.5rem; margin-bottom:12px; }
.empty-state p { font-size:.88rem; font-weight:300; line-height:1.6; }
.footer { text-align:center; margin-top:56px; padding-top:20px; border-top:1px solid var(--border); font-size:.75rem; color:var(--muted); font-weight:300; letter-spacing:.04em; }
.footer span { background:linear-gradient(90deg,var(--rob),var(--lizet)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:600; }
```

  </style>
</head>
<body>
<div id="app">

  <div id="sync-bar">
    <div class="sync-dot"></div>
    <span id="sync-text">Verbonden &#8212; afspraken worden gedeeld met Lizet</span>
  </div>

  <div id="notif-banner">
    <p><strong>&#128276; Meldingen inschakelen</strong>Ontvang herinneringen voor je afspraken.</p>
    <button id="notif-allow-btn">Toestaan</button>
    <button id="notif-dismiss">&#10005;</button>
  </div>

  <div class="header">
    <h1>Onze Agenda</h1>
    <div class="header-names">
      <span class="name-pill rob">&#128100; Rob</span>
      <span class="name-pill lizet">&#128105; Lizet</span>
    </div>
    <p>Spreek, typ of scan je afspraken in</p>
  </div>

  <div class="mic-section">
    <div class="mic-ring" id="mic-ring">
      <button id="mic-btn" title="Start opname">&#127897;&#65039;</button>
    </div>
    <div id="status-text">Tik de microfoon om een afspraak in te spreken</div>
    <div id="transcript-box"></div>
    <div class="alert warn" id="alert-blocked">
      <strong>&#128274; Microfoon geblokkeerd</strong>
      Safari staat de microfoon niet toe. Oplossing:<br>
      1. Ga naar <strong>Instellingen &rarr; Safari &rarr; Microfoon</strong> &rarr; Toestaan<br>
      2. Herlaad de pagina en probeer opnieuw
    </div>
    <div class="alert error" id="alert-error"></div>

```
<!-- Camera scan -->
<div class="scan-section">
  <button id="scan-btn" title="Scan afsprakenbrief">&#128247; Scan afsprakenbrief</button>
  <div id="scan-label">Maak een foto van een brief of uitnodiging</div>
  <input id="camera-input" type="file" accept="image/*" capture="camera" />
</div>

<!-- Scan preview -->
<div id="scan-preview">
  <img id="preview-img" src="" alt="Scan preview" />
  <div id="scan-status">&#128247; Foto ontvangen &mdash; brief wordt gelezen&hellip;</div>
  <div class="alert error" id="alert-scan-error"></div>
</div>

<div id="text-section">
  <div id="text-hint">Typ je afspraak &mdash; bv. "Vrijdag 14 maart om 10:00 tandarts voor Rob"</div>
  <div class="text-row">
    <input id="text-input" type="text" placeholder="Afspraak beschrijving..." autocomplete="off" />
    <button id="text-submit">&#10133;</button>
  </div>
  <div class="alert error" id="alert-text-error"></div>
</div>
<button class="mode-toggle" id="mode-toggle">&#9000;&#65039; Liever typen? Gebruik tekstinvoer</button>
```

  </div>

  <div class="tabs">
    <button class="tab active" data-tab="alle">&#128467; Alle <span id="count-alle">(0)</span></button>
    <button class="tab" data-tab="rob">&#128100; Rob <span id="count-rob">(0)</span></button>
    <button class="tab" data-tab="lizet">&#128105; Lizet <span id="count-lizet">(0)</span></button>
  </div>

  <div id="search-wrap">
    <span id="search-icon">&#128269;</span>
    <input id="search-input" type="search" placeholder="Zoeken in afspraken..." autocomplete="off" />
    <button id="search-clear" title="Wis">&#10005;</button>
  </div>
  <div id="search-count"></div>

  <div id="export-bar">
    <p>&#128197; Exporteer als .ics &mdash; werkt met Apple Agenda, Google Agenda &amp; Outlook.</p>
    <button id="export-all-btn">Alles exporteren</button>
  </div>

  <div id="apt-list">
    <div class="empty-state">
      <div class="icon">&#128257;</div>
      <p>Verbinden met Firebase&hellip;</p>
    </div>
  </div>

  <div id="toast"></div>
  <div class="footer"><span>Made by Rob Borghouts</span> &middot; 2026</div>
</div>

<script>
// â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var firebaseConfig = {
  apiKey:            "AIzaSyDeGP5IIWaFoG4PuISUueeccexrZOIVwGY",
  authDomain:        "agenda-roblizet.firebaseapp.com",
  databaseURL:       "https://agenda-roblizet-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "agenda-roblizet",
  storageBucket:     "agenda-roblizet.firebasestorage.app",
  messagingSenderId: "789902813974",
  appId:             "1:789902813974:web:62231ad5f5f90b4a91fe37"
};
firebase.initializeApp(firebaseConfig);
var db    = firebase.database();
var dbRef = db.ref("appointments");

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var REMIND_KEY   = "afspraken_reminders";
var appointments = [];
var reminders    = {};
var timers       = {};
var activeTab    = "alle";
var searchQuery  = "";
var textMode     = false;
var listening    = false;
var processing   = false;
var recognition  = null;
var finalText    = "";
var exported     = {};
var openPopover  = null;
try { reminders = JSON.parse(localStorage.getItem(REMIND_KEY)) || {}; } catch(e) {}

// â”€â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var syncBar       = document.getElementById("sync-bar");
var syncText      = document.getElementById("sync-text");
var notifBanner   = document.getElementById("notif-banner");
var notifAllowBtn = document.getElementById("notif-allow-btn");
var notifDismiss  = document.getElementById("notif-dismiss");
var micRing       = document.getElementById("mic-ring");
var micBtn        = document.getElementById("mic-btn");
var statusText    = document.getElementById("status-text");
var transcriptBox = document.getElementById("transcript-box");
var alertBlocked  = document.getElementById("alert-blocked");
var alertError    = document.getElementById("alert-error");
var scanBtn       = document.getElementById("scan-btn");
var cameraInput   = document.getElementById("camera-input");
var scanPreview   = document.getElementById("scan-preview");
var previewImg    = document.getElementById("preview-img");
var scanStatus    = document.getElementById("scan-status");
var alertScanErr  = document.getElementById("alert-scan-error");
var textSection   = document.getElementById("text-section");
var textInput     = document.getElementById("text-input");
var textSubmit    = document.getElementById("text-submit");
var alertTextErr  = document.getElementById("alert-text-error");
var modeToggle    = document.getElementById("mode-toggle");
var searchInput   = document.getElementById("search-input");
var searchClear   = document.getElementById("search-clear");
var searchCount   = document.getElementById("search-count");
var aptList       = document.getElementById("apt-list");
var exportBar     = document.getElementById("export-bar");
var exportAllBtn  = document.getElementById("export-all-btn");
var toastEl       = document.getElementById("toast");

var MONTHS = {januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,augustus:7,september:8,oktober:9,november:10,december:11};

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveReminders() { try { localStorage.setItem(REMIND_KEY, JSON.stringify(reminders)); } catch(e) {} }
function showAlert(el, msg) { el.innerHTML = msg||""; el.style.display = msg ? "block" : "none"; }
function clearAlerts() { showAlert(alertBlocked,""); showAlert(alertError,""); showAlert(alertTextErr,""); showAlert(alertScanErr,""); }
function escH(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function highlight(text, q) {
  if (!q) return escH(text);
  var safe = escH(text);
  return safe.replace(new RegExp("("+q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi"),"<mark>$1</mark>");
}
function aptSortKey(a) {
  if (a.dateISO) return a.dateISO+"T"+(a.time?a.time.replace(":",""):"0000");
  return "9999-99-99T"+new Date(a.createdAt).getTime();
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var toastTimer = null;
function showToast(msg) {
  toastEl.innerHTML = msg;
  toastEl.style.display = "block";
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ toastEl.style.display = "none"; }, 4000);
}

// â”€â”€â”€ Firebase sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref(".info/connected").on("value", function(snap) {
  var ok = snap.val() === true;
  syncBar.style.display = "flex";
  syncBar.className = ok ? "" : "error";
  syncText.textContent = ok
    ? "Verbonden \u2014 afspraken worden gedeeld met Lizet"
    : "Geen verbinding \u2014 wordt gesynchroniseerd zodra je online bent";
});

dbRef.on("value", function(snap) {
  var data = snap.val();
  appointments = data
    ? Object.keys(data).map(function(k){ var a=data[k]; a.id=k; return a; })
    : [];
  scheduleAllReminders();
  render();
}, function(err) {
  syncBar.className = "error";
  syncText.textContent = "Verbindingsfout: "+err.message;
});

// â”€â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function notifSupported() { return "Notification" in window; }
function checkNotifBanner() {
  if (!notifSupported()) return;
  notifBanner.style.display = Notification.permission === "default" ? "flex" : "none";
}
function requestNotifPermission() {
  if (!notifSupported()) return;
  Notification.requestPermission().then(function(r){
    notifBanner.style.display = "none";
    if (r === "granted") { showToast("&#128276; Meldingen ingeschakeld!"); scheduleAllReminders(); render(); }
  });
}
function aptDateTime(apt) {
  if (!apt.dateISO) return null;
  var d = new Date(apt.dateISO);
  if (apt.time) { var p=apt.time.split(":"); d.setHours(parseInt(p[0]),parseInt(p[1]),0,0); }
  else d.setHours(8,0,0,0);
  return d;
}
function scheduleReminder(apt) {
  var mins = reminders[apt.id]; if (mins===undefined) return;
  if (!notifSupported()||Notification.permission!=="granted") return;
  if (timers[apt.id]) { clearTimeout(timers[apt.id]); delete timers[apt.id]; }
  var dt = aptDateTime(apt); if (!dt) return;
  var delay = dt.getTime()-mins*60000-Date.now(); if (delay<0) return;
  timers[apt.id] = setTimeout(function(){
    var who=apt.person==="beide"?"Rob & Lizet":apt.person==="rob"?"Rob":"Lizet";
    try { new Notification(apt.description,{body:(apt.date||apt.dateISO)+(apt.time?" om "+apt.time:"")+" \u2022 "+who}); }
    catch(e) { showToast("&#128276; Herinnering: "+apt.description); }
    delete timers[apt.id];
  }, delay);
}
function scheduleAllReminders() { appointments.forEach(function(a){ if(reminders[a.id]!==undefined) scheduleReminder(a); }); }
function cancelReminder(id) { if(timers[id]){clearTimeout(timers[id]);delete timers[id];} delete reminders[id]; saveReminders(); }
function setReminder(apt, mins) { reminders[apt.id]=mins; saveReminders(); scheduleReminder(apt); }
var REMINDER_OPTIONS = [
  {label:"15 minuten van tevoren",mins:15},
  {label:"1 uur van tevoren",mins:60},
  {label:"Ochtend van de dag",mins:480},
  {label:"1 dag van tevoren",mins:1440},
  {label:"1 week van tevoren",mins:10080}
];
function reminderLabel(mins) { var o=REMINDER_OPTIONS.find(function(x){return x.mins===mins;}); return o?o.label:mins+" min"; }

// â”€â”€â”€ Parsers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseFallback(text) {
  var lower=text.toLowerCase(), person="beide";
  if(lower.includes("lizet")&&!lower.includes("rob")) person="lizet";
  else if(lower.includes("rob")&&!lower.includes("lizet")) person="rob";
  var dm=lower.match(/(\d{1,2})\s*(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)/);
  var tm=lower.match(/(\d{1,2})[:.h](\d{2})/);
  var dateStr=null,dateISO=null;
  if(dm){ var day=parseInt(dm[1]),month=MONTHS[dm[2]],year=new Date().getFullYear();
    var d=new Date(year,month,day);
    dateStr=d.toLocaleDateString("nl-NL",{day:"numeric",month:"long",year:"numeric"});
    dateISO=year+"-"+String(month+1).padStart(2,"0")+"-"+String(day).padStart(2,"0"); }
  var time=tm?String(tm[1]).padStart(2,"0")+":"+tm[2]:null;
  return {person:person,description:text,date:dateStr,dateISO:dateISO,time:time,icon:"ğŸ“…"};
}

var AI_SYSTEM_AFSPRAAK = "Je bent een assistent die gesproken tekst omzet naar afspraakgegevens. Vandaag is het {{TODAY}} ({{ISO}}).\nDe gebruikers heten Rob en Lizet.\nGeef altijd JSON terug (geen markdown), met deze velden:\n- person: \"rob\", \"lizet\", of \"beide\"\n- description: korte beschrijving (max 80 tekens)\n- date: datum als \"d MMMM yyyy\" in het Nederlands, of null\n- dateISO: datum als \"YYYY-MM-DD\", of null\n- time: tijd als \"HH:mm\", of null\n- icon: 1 passend emoji\nGeef ALLEEN de JSON terug.";

function getSystemPrompt() {
  var today = new Date().toLocaleDateString("nl-NL",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  var iso   = new Date().toISOString().slice(0,10);
  return AI_SYSTEM_AFSPRAAK.replace("{{TODAY}}",today).replace("{{ISO}}",iso);
}

async function parseWithAI(text) {
  var res = await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      model:"claude-sonnet-4-20250514", max_tokens:1000,
      system: getSystemPrompt(),
      messages:[{role:"user",content:"Zet deze tekst om naar een afspraak: \""+text+"\""}]
    })
  });
  var data = await res.json();
  var raw = data.content&&data.content[0]&&data.content[0].text;
  if (!raw) throw new Error("geen response");
  return JSON.parse(raw.replace(/```json|```/g,"").trim());
}

// â”€â”€â”€ Camera scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function parseFromImage(base64, mimeType) {
  var today = new Date().toLocaleDateString("nl-NL",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  var iso   = new Date().toISOString().slice(0,10);
  var system = "Je bent een assistent die afspraken uit ingescande brieven, uitnodigingen of documenten haalt. Vandaag is het "+today+" ("+iso+").\nDe gebruikers heten Rob en Lizet.\nAnalyseer de afbeelding en zoek alle afspraken, afspraakinformatie, data, tijden en personen.\nGeef een JSON-array terug (geen markdown) met afspraken. Elke afspraak heeft:\n- person: \"rob\", \"lizet\", of \"beide\"\n- description: korte beschrijving (max 80 tekens)\n- date: datum als \"d MMMM yyyy\" in het Nederlands, of null\n- dateISO: datum als \"YYYY-MM-DD\", of null\n- time: tijd als \"HH:mm\", of null\n- icon: 1 passend emoji\nAls er meerdere afspraken zijn geef ze allemaal terug als array. Als er slechts 1 is geef dan toch een array met 1 item. Geef ALLEEN de JSON array terug.";

  var res = await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      model:"claude-sonnet-4-20250514", max_tokens:2000,
      system: system,
      messages:[{role:"user",content:[
        {type:"image",source:{type:"base64",media_type:mimeType,data:base64}},
        {type:"text",text:"Haal alle afspraken uit deze afbeelding/brief."}
      ]}]
    })
  });
  var data = await res.json();
  var raw = data.content&&data.content[0]&&data.content[0].text;
  if (!raw) throw new Error("geen response");
  var parsed = JSON.parse(raw.replace(/```json|```/g,"").trim());
  return Array.isArray(parsed) ? parsed : [parsed];
}

function fileToBase64(file) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var result = e.target.result;
      var base64 = result.split(",")[1];
      resolve({base64:base64, mimeType:file.type||"image/jpeg"});
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleScan(file) {
  clearAlerts();
  // Show preview
  var objectUrl = URL.createObjectURL(file);
  previewImg.src = objectUrl;
  scanPreview.classList.add("visible");
  scanStatus.className = "scanning";
  scanStatus.textContent = "Brief wordt gelezen door AI\u2026";
  scanBtn.disabled = true;

  try {
    var imgData = await fileToBase64(file);
    var apts    = await parseFromImage(imgData.base64, imgData.mimeType);

    var count = 0;
    for (var i = 0; i < apts.length; i++) {
      var parsed = apts[i];
      if (!parsed.description) continue;
      var newRef = dbRef.push();
      await newRef.set({
        person:      parsed.person      || "beide",
        description: parsed.description,
        date:        parsed.date        || null,
        dateISO:     parsed.dateISO     || null,
        time:        parsed.time        || null,
        icon:        parsed.icon        || "ğŸ“…",
        createdAt:   new Date().toISOString(),
        rawText:     "Gescand via camera"
      });
      count++;
    }

    scanStatus.className = "";
    scanStatus.textContent = count > 0
      ? "\u2705 "+count+" afspraak"+(count!==1?"en":"")+" toegevoegd uit de brief!"
      : "\u26a0\ufe0f Geen afspraken gevonden in dit document.";

    if (count > 0) showToast("&#128247; "+count+" afspraak"+(count!==1?"en":"")+" gescand en toegevoegd!");

    // Hide preview after 4 seconds
    setTimeout(function(){
      scanPreview.classList.remove("visible");
      URL.revokeObjectURL(objectUrl);
    }, 4000);

  } catch(e) {
    scanStatus.className = "";
    showAlert(alertScanErr, "Kon de brief niet lezen. Probeer een duidelijkere foto.");
    console.error("Scan error:", e);
  } finally {
    scanBtn.disabled = false;
    cameraInput.value = "";
  }
}

// â”€â”€â”€ Process text input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processInput(text) {
  if (!text.trim()||processing) return;
  clearAlerts();
  setProcessingState(true);
  try {
    var parsed;
    try { parsed = await parseWithAI(text); } catch(e) { parsed = parseFallback(text); }
    var newRef = dbRef.push();
    await newRef.set({
      person:      parsed.person      || "beide",
      description: parsed.description,
      date:        parsed.date        || null,
      dateISO:     parsed.dateISO     || null,
      time:        parsed.time        || null,
      icon:        parsed.icon        || "ğŸ“…",
      createdAt:   new Date().toISOString(),
      rawText:     text
    });
    transcriptBox.style.display="none"; transcriptBox.textContent="";
    textInput.value=""; finalText="";
    if(notifSupported()&&Notification.permission==="default") notifBanner.style.display="flex";
  } catch(e) {
    if(textMode) showAlert(alertTextErr,"Kon de afspraak niet verwerken. Probeer opnieuw.");
    else         showAlert(alertError,  "Kon de afspraak niet verwerken. Probeer opnieuw.");
  } finally { setProcessingState(false); }
}

// â”€â”€â”€ Speech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setListeningState(val) {
  listening=val; micRing.classList.toggle("listening",val); micBtn.classList.toggle("active",val);
  micBtn.textContent=val?"â¹":(processing?"âš™ï¸":"ğŸ™ï¸");
  statusText.className=val?"active":(processing?"processing":"");
  statusText.textContent=val?"Luisteren\u2026 spreek uw afspraak in":(processing?"Verwerken\u2026":"Tik de microfoon om een afspraak in te spreken");
}
function setProcessingState(val) {
  processing=val; micBtn.classList.toggle("busy",val); textSubmit.disabled=val;
  if(!listening){
    micBtn.textContent=val?"âš™ï¸":"ğŸ™ï¸";
    statusText.className=val?"processing":"";
    statusText.textContent=val?"Verwerken\u2026":"Tik de microfoon om een afspraak in te spreken";
  }
}
function startSpeech() {
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){showAlert(alertError,"Spraakherkenning niet ondersteund. Gebruik de tekstinvoer.");return;}
  clearAlerts(); finalText="";
  recognition=new SR(); recognition.lang="nl-NL"; recognition.continuous=false; recognition.interimResults=true;
  recognition.onstart=function(){setListeningState(true);};
  recognition.onresult=function(e){
    var interim="";
    for(var i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal) finalText+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    var disp=(finalText+interim).trim();
    if(disp){transcriptBox.textContent='"'+disp+'"';transcriptBox.style.display="block";}
  };
  recognition.onend=function(){setListeningState(false);if(finalText.trim())processInput(finalText.trim());};
  recognition.onerror=function(e){
    setListeningState(false);
    if(e.error==="not-allowed") alertBlocked.style.display="block";
    else if(e.error!=="no-speech"&&e.error!=="aborted") showAlert(alertError,"Fout: "+e.error);
  };
  recognition.start();
}
function stopSpeech(){if(recognition)recognition.stop();}

// â”€â”€â”€ ICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toICSDate(iso,time){if(!iso)return null;var p=iso.split("-");if(time){var t=time.split(":");return p[0]+p[1]+p[2]+"T"+t[0]+t[1]+"00";}return p[0]+p[1]+p[2];}
function buildICS(apts){
  var lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Rob Borghouts//Onze Agenda//NL","CALSCALE:GREGORIAN","METHOD:PUBLISH"];
  apts.forEach(function(a){
    var dt=toICSDate(a.dateISO,a.time);if(!dt)return;
    var who=a.person==="beide"?"Rob & Lizet":a.person==="rob"?"Rob":"Lizet";
    lines.push("BEGIN:VEVENT","UID:"+a.id+"@onze-agenda","SUMMARY:"+(a.icon||"")+" "+a.description,"DESCRIPTION:Afspraak voor "+who);
    if(!a.time){lines.push("DTSTART;VALUE=DATE:"+dt);var nx=new Date(a.dateISO);nx.setDate(nx.getDate()+1);var np=nx.toISOString().slice(0,10).split("-");lines.push("DTEND;VALUE=DATE:"+np[0]+np[1]+np[2]);}
    else{lines.push("DTSTART:"+dt);var hp=a.time.split(":").map(Number),dp=a.dateISO.split("-");lines.push("DTEND:"+dp[0]+dp[1]+dp[2]+"T"+String(hp[0]+1).padStart(2,"0")+String(hp[1]).padStart(2,"0")+"00");}
    lines.push("DTSTAMP:"+new Date().toISOString().replace(/[-:.]/g,"").slice(0,15)+"Z","END:VEVENT");
  });
  lines.push("END:VCALENDAR");return lines.join("\r\n");
}
function downloadICS(apts,name){var blob=new Blob([buildICS(apts)],{type:"text/calendar;charset=utf-8"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  document.getElementById("count-alle").textContent ="("+appointments.length+")";
  document.getElementById("count-rob").textContent  ="("+appointments.filter(function(a){return a.person==="rob";}).length+")";
  document.getElementById("count-lizet").textContent="("+appointments.filter(function(a){return a.person==="lizet";}).length+")";
  exportBar.style.display=appointments.length>0?"flex":"none";
  var filtered=activeTab==="alle"?appointments.slice():appointments.filter(function(a){return a.person===activeTab;});
  var q=searchQuery.trim().toLowerCase();
  if(q) filtered=filtered.filter(function(a){return(a.description||"").toLowerCase().includes(q)||(a.date||"").toLowerCase().includes(q)||(a.rawText||"").toLowerCase().includes(q);});
  filtered.sort(function(a,b){var ka=aptSortKey(a),kb=aptSortKey(b);return ka<kb?-1:ka>kb?1:0;});
  if(q){searchCount.style.display="block";searchCount.textContent=filtered.length===0?"Geen resultaten voor \u201C"+searchQuery+"\u201D":filtered.length+" resultaat"+(filtered.length!==1?"en":"")+" voor \u201C"+searchQuery+"\u201D";}
  else searchCount.style.display="none";
  if(filtered.length===0){
    aptList.innerHTML=q?'<div class="empty-state"><div class="icon">&#128269;</div><p>Geen afspraken gevonden.</p></div>':'<div class="empty-state"><div class="icon">&#127897;&#65039;</div><p>Geen afspraken.<br>Spreek, typ of scan een afspraak in!</p></div>';
    return;
  }
  var canNotif=notifSupported()&&Notification.permission==="granted";
  var html="", groupKeys=[], groups={};
  filtered.forEach(function(a){var k=a.date||"Geen datum";if(!groups[k]){groups[k]=[];groupKeys.push(k);}groups[k].push(a);});
  groupKeys.forEach(function(date){
    var apts=groups[date];
    html+='<div class="section-title">'+escH(date)+'<span class="count-badge">'+apts.length+"</span></div>";
    apts.forEach(function(a){
      var who=a.person==="beide"?"Rob & Lizet":a.person==="rob"?"Rob":"Lizet";
      var expDone=exported[a.id], hasRem=reminders[a.id]!==undefined;
      var calBtn=a.dateISO?'<button class="apt-cal-btn'+(expDone?" done":"")+'" data-id="'+a.id+'">'+(expDone?"&#10003;":"&#128229;")+"</button>":"";
      var bellBtn=(a.dateISO&&canNotif)?'<button class="apt-bell-btn'+(hasRem?" set":"")+'" data-id="'+a.id+'">&#128276;</button>':"";
      var remBadge=hasRem?'<span class="reminder-badge">&#128276; '+escH(reminderLabel(reminders[a.id]))+"</span>":"";
      var popOpts="";
      if(a.dateISO&&canNotif){
        REMINDER_OPTIONS.forEach(function(o){var act=reminders[a.id]===o.mins;popOpts+='<button class="reminder-opt'+(act?" active":"")+'" data-id="'+a.id+'" data-mins="'+o.mins+'">'+escH(o.label)+(act?" &#10003;":"")+"</button>";});
        if(hasRem) popOpts+='<button class="reminder-opt cancel" data-id="'+a.id+'" data-mins="cancel">&#10005; Herinnering verwijderen</button>';
      }
      var pop=(a.dateISO&&canNotif)?'<div class="reminder-popover" id="pop-'+a.id+'"><p>Herinnering</p>'+popOpts+"</div>":"";
      html+='<div class="apt-card '+a.person+'" style="margin-bottom:8px" data-id="'+a.id+'">'
        +'<div class="apt-icon">'+(a.icon||"&#128197;")+"</div>"
        +'<div class="apt-body">'
        +'<div class="apt-who '+a.person+'">'+escH(who)+"</div>"
        +'<div class="apt-desc">'+highlight(a.description,searchQuery.trim())+"</div>"
        +'<div class="apt-meta">'+(a.time?'<span>&#128336; '+escH(a.time)+"</span>":"")+
        '<span>'+new Date(a.createdAt).toLocaleDateString("nl-NL",{day:"numeric",month:"short"})+"</span>"+remBadge+
        "</div></div>"
        +'<div class="apt-actions">'+calBtn+bellBtn+pop+'<button class="apt-del-btn" data-id="'+a.id+'">&#128465;</button></div>'
        +"</div>";
    });
  });
  aptList.innerHTML=html;
}

// â”€â”€â”€ Popovers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeAllPopovers(){document.querySelectorAll(".reminder-popover.open").forEach(function(p){p.classList.remove("open");});openPopover=null;}

// â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
notifAllowBtn.addEventListener("click",requestNotifPermission);
notifDismiss.addEventListener("click",function(){notifBanner.style.display="none";});
micBtn.addEventListener("click",function(){if(processing)return;if(listening)stopSpeech();else startSpeech();});

// Camera scan
scanBtn.addEventListener("click",function(){ cameraInput.click(); });
cameraInput.addEventListener("change",function(e){
  var file=e.target.files&&e.target.files[0];
  if(file) handleScan(file);
});

modeToggle.addEventListener("click",function(){
  textMode=!textMode;clearAlerts();
  if(textMode){textSection.classList.add("visible");modeToggle.textContent="&#127897;&#65039; Terug naar spraakopname";micRing.style.display="none";statusText.style.display="none";}
  else{textSection.classList.remove("visible");modeToggle.textContent="&#9000;&#65039; Liever typen? Gebruik tekstinvoer";micRing.style.display="";statusText.style.display="";}
});

textSubmit.addEventListener("click",function(){processInput(textInput.value);});
textInput.addEventListener("keydown",function(e){if(e.key==="Enter")processInput(textInput.value);});
searchInput.addEventListener("input",function(){searchQuery=searchInput.value;searchClear.style.display=searchQuery?"block":"none";render();});
searchClear.addEventListener("click",function(){searchInput.value="";searchQuery="";searchClear.style.display="none";searchInput.focus();render();});

document.querySelectorAll(".tab").forEach(function(btn){
  btn.addEventListener("click",function(){
    document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");});
    btn.classList.add("active");activeTab=btn.dataset.tab;render();
  });
});

exportAllBtn.addEventListener("click",function(){
  var wd=appointments.filter(function(a){return a.dateISO;});
  if(!wd.length){alert("Geen afspraken met een datum.");return;}
  downloadICS(wd,"onze-agenda.ics");
});

aptList.addEventListener("click",function(e){
  var del=e.target.closest(".apt-del-btn");
  var cal=e.target.closest(".apt-cal-btn");
  var bell=e.target.closest(".apt-bell-btn");
  var opt=e.target.closest(".reminder-opt");
  if(del){cancelReminder(del.dataset.id);dbRef.child(del.dataset.id).remove();return;}
  if(cal){var apt=appointments.find(function(a){return a.id===cal.dataset.id;});if(!apt)return;downloadICS([apt],apt.description.slice(0,30).replace(/\s/g,"-")+".ics");exported[cal.dataset.id]=true;render();return;}
  if(bell){e.stopPropagation();var pop=document.getElementById("pop-"+bell.dataset.id);if(!pop)return;if(pop.classList.contains("open")){pop.classList.remove("open");openPopover=null;}else{closeAllPopovers();pop.classList.add("open");openPopover=bell.dataset.id;}return;}
  if(opt){e.stopPropagation();var apt2=appointments.find(function(a){return a.id===opt.dataset.id;});if(!apt2)return;closeAllPopovers();if(opt.dataset.mins==="cancel"){cancelReminder(opt.dataset.id);showToast("&#128276; Herinnering verwijderd");}else{setReminder(apt2,parseInt(opt.dataset.mins));showToast("&#128276; Herinnering ingesteld: "+reminderLabel(parseInt(opt.dataset.mins)));}render();return;}
  closeAllPopovers();
});

document.addEventListener("click",function(e){if(!e.target.closest(".apt-actions"))closeAllPopovers();});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkNotifBanner();
</script>

</body>
</html>