<!DOCTYPE html>

<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Onze Agenda &#8211; Rob &amp; Lizet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f19;
      --surface:#121a2a;
      --surface2:#0f1626;
      --text:#e9eefc;
      --muted:#9fb0d0;
      --border:rgba(255,255,255,.08);
      --shadow: 0 14px 40px rgba(0,0,0,.35);

      --rob:#5fe2ff;
      --rob-bg:rgba(95,226,255,.12);
      --rob-border:rgba(95,226,255,.22);

      --lizet:#ff77c8;
      --lizet-bg:rgba(255,119,200,.12);
      --lizet-border:rgba(255,119,200,.22);

      --beide:#ffd86b;
      --beide-bg:rgba(255,216,107,.12);
      --beide-border:rgba(255,216,107,.22);

      --danger:#ff5a5f;
      --ok:#55f0a6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% -10%, #1c2a52 0%, transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, #2a1c52 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      padding:16px;
    }

    .app{
      max-width:980px;
      margin:0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    header{
      padding:18px 18px 12px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      z-index:3;
    }

    .topline{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .logo{
      width:40px;
      height:40px;
      border-radius:14px;
      background: radial-gradient(circle at 30% 20%, rgba(95,226,255,.7), transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(255,119,200,.6), transparent 55%),
                  rgba(255,255,255,.06);
      border:1px solid var(--border);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }

    .logo span{font-size:20px}

    h1{
      font-size:1.2rem;
      margin:0;
      letter-spacing:.2px;
      line-height:1.1;
      font-family:"Playfair Display",serif;
      font-weight:700;
    }

    .subtitle{
      color:var(--muted);
      font-size:.85rem;
      margin-top:2px;
      font-weight:700;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.18);
    }

    .counts{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:.78rem;
      color:var(--muted);
      margin-top:10px;
      font-weight:700;
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }

    .content{
      padding:16px 18px 22px 18px;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .search{
      flex:1;
      min-width:220px;
      position:relative;
    }

    .search input{
      width:100%;
      padding:12px 44px 12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:.95rem;
      -webkit-appearance:none;
      font-weight:700;
    }
    .search input::placeholder{color:rgba(159,176,208,.75)}
    .search button{
      position:absolute;
      right:8px;
      top:50%;
      transform: translateY(-50%);
      border:0;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:18px;
      padding:6px 8px;
      border-radius:10px;
      font-weight:800;
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-size:.9rem;
      font-weight:800;
    }
    .toggle .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 6px rgba(85,240,166,.12);
    }
    .toggle.off .dot{
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(255,90,95,.12);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }

    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }

    .card h2{
      margin:0;
      padding:14px 14px 10px 14px;
      font-size:1rem;
      border-bottom:1px solid var(--border);
      color:rgba(233,238,252,.95);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:900;
    }

    .card .body{
      padding:14px;
    }

    label{
      display:block;
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:6px;
      margin-top:12px;
      font-weight:800;
    }

    input[type="text"], input[type="date"], input[type="time"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      font-size:0.95rem;
      outline:none;
      -webkit-appearance:none;
      font-weight:700;
    }

    textarea{
      min-height:90px;
      resize:vertical;
      font-weight:700;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .row > *{flex:1}

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    button.primary{
      flex:1;
      min-width:160px;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(95,226,255,.22), rgba(95,226,255,.10));
      color:var(--text);
      font-weight:900;
      font-size:0.95rem;
    }
    button.secondary{
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      font-size:0.95rem;
    }

    .list{
      padding:12px 14px 14px 14px;
    }

    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:900;
      margin:6px 0 10px 0;
      color:rgba(233,238,252,.95);
    }

    .count-badge{
      font-size:.78rem;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.03);
      font-weight:900;
    }

    .apt-card{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(255,255,255,.03);
      margin-bottom:10px;
    }

    .apt-icon{
      width:42px;
      height:42px;
      border-radius:14px;
      border:1px solid var(--border);
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.03);
      font-size:18px;
      flex:0 0 42px;
    }

    .apt-body{
      flex:1;
      min-width:0;
    }

    .apt-who{
      font-weight:900;
      letter-spacing:.2px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      margin-bottom:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }

    .apt-desc{
      font-weight:900;
      margin-bottom:8px;
      line-height:1.25;
      word-wrap:break-word;
    }

    .apt-meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:.85rem;
      font-weight:800;
    }

    .apt-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }

    .apt-actions button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      padding:10px 10px;
      border-radius:12px;
      font-size:16px;
      -webkit-tap-highlight-color: transparent;
      font-weight:900;
    }

    .rob .apt-who{ color:var(--rob); border-color: var(--rob-border); background: var(--rob-bg) }
    .rob .apt-icon{ border-color: var(--rob-border); background: var(--rob-bg) }
    .lizet .apt-who{ color:var(--lizet); border-color: var(--lizet-border); background: var(--lizet-bg) }
    .lizet .apt-icon{ border-color: var(--lizet-border); background: var(--lizet-bg) }
    .beide .apt-who{ color:var(--beide); border-color: var(--beide-border); background: var(--beide-bg) }
    .beide .apt-icon{ border-color: var(--beide-border); background: var(--beide-bg) }

    .empty-state{
      padding:26px 14px;
      text-align:center;
      color:var(--muted);
      font-weight:900;
    }
    .empty-state .icon{
      font-size:34px;
      margin-bottom:8px;
      opacity:.9;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(18,26,42,.92);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease;
      z-index:10;
      max-width: 92vw;
      text-align:center;
      font-weight:900;
    }
    .toast.show{opacity:1}

    .footerbar{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .footerbar .small{
      color:var(--muted);
      font-size:.82rem;
      font-weight:800;
    }

    .exportbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .exportbar button{
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      font-size:.85rem;
    }

    .madeby{
      color:rgba(159,176,208,.9);
      font-size:.8rem;
      margin-top:10px;
      text-align:right;
      padding-right:6px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topline">
        <div class="brand">
          <div class="logo"><span>üìÖ</span></div>
          <div>
            <h1>Onze Agenda</h1>
            <div class="subtitle">Rob &amp; Lizet, afspraken, export, herinneringen</div>
          </div>
        </div>

        <div class="toggle" id="reminder-toggle" title="Herinneringen aan of uit">
          <div class="dot"></div>
          <div>Herinneringen</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="alle">üìÖ Alle <span id="count-alle">(0)</span></button>
        <button class="tab" data-tab="rob">üë§ Rob <span id="count-rob">(0)</span></button>
        <button class="tab" data-tab="lizet">üë© Lizet <span id="count-lizet">(0)</span></button>
        <button class="tab" data-tab="verjaardagen">üéÇ Verjaardagen <span id="count-bdays">(0)</span></button>
        <button class="tab" data-tab="herinneringen">üïØÔ∏è Herinneringen <span id="count-mem">(0)</span></button>
      </div>

      <div class="counts" id="summary-pills">
        <div class="pill" id="pill-today">Vandaag: 0</div>
        <div class="pill" id="pill-week">Deze week: 0</div>
        <div class="pill" id="pill-total">Totaal: 0</div>
      </div>
    </header>

    <div class="content">
      <div class="controls">
        <div class="search">
          <input id="search-input" type="text" placeholder="Zoek in afspraken, verjaardagen, herinneringen..." autocomplete="off" />
          <button id="search-clear" title="Wis">‚úï</button>
        </div>

        <div class="toggle off" id="mode-toggle" title="Spraak of tekst invoer">
          <div class="dot"></div>
          <div id="mode-label">Spraak</div>
        </div>
      </div>

      <div id="search-count"></div>

      <div id="bday-section" style="display:none; margin-bottom:16px;">
        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <input id="bday-name" type="text" placeholder="Naam..." autocomplete="off"
            style="flex:1; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;" />
          <input id="bday-date" type="date"
            style="width:150px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 12px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;" />
          <button id="bday-add"
            style="background:var(--beide-bg); border:1px solid var(--beide-border); color:var(--beide); border-radius:12px; padding:12px 14px; font-family:'DM Sans',sans-serif; font-size:1.0rem; cursor:pointer; font-weight:900;">
            ‚ûï
          </button>
        </div>

        <div id="bday-actions" style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="bday-export"
            style="background:var(--rob-bg); border:1px solid var(--rob-border); color:var(--rob); border-radius:10px; padding:10px 12px; font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; font-weight:900;">
            üì• Exporteer verjaardagen
          </button>
        </div>
      </div>

      <div id="mem-section" style="display:none; margin-bottom:16px;">
        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
          <input id="mem-name" type="text" placeholder="Naam..." autocomplete="off"
            style="flex:1; min-width:160px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;" />

          <select id="mem-type"
            style="width:160px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 12px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;">
            <option value="Overlijden">Overlijden</option>
            <option value="Herdenking">Herdenking</option>
            <option value="Jubileum">Jubileum</option>
            <option value="Anders">Anders</option>
          </select>

          <input id="mem-date" type="date"
            style="width:150px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 12px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;" />

          <button id="mem-add"
            style="background:var(--beide-bg); border:1px solid var(--beide-border); color:var(--beide); border-radius:12px; padding:12px 14px; font-family:'DM Sans',sans-serif; font-size:1.0rem; cursor:pointer; font-weight:900;">
            ‚ûï
          </button>
        </div>

        <input id="mem-note" type="text" placeholder="Notitie, bijv. kaarsje, bloemen, bezoek..."
          style="width:100%; margin-bottom:10px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--text); outline:none; -webkit-appearance:none; font-weight:800;" />

        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="mem-export"
            style="background:var(--rob-bg); border:1px solid var(--rob-border); color:var(--rob); border-radius:10px; padding:10px 12px; font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; font-weight:900;">
            üì• Exporteer herinneringen
          </button>
        </div>
      </div>
     <div class="grid">
        <div class="card" id="left-card">
          <h2>
            <span>Nieuwe afspraak</span>
            <span style="color:var(--muted); font-weight:800; font-size:.85rem;">snelle invoer</span>
          </h2>
          <div class="body">
            <label>Voor wie</label>
            <select id="who">
              <option value="beide">Beide</option>
              <option value="rob">Rob</option>
              <option value="lizet">Lizet</option>
            </select>

            <div class="row">
              <div>
                <label>Datum</label>
                <input id="date" type="date" />
              </div>
              <div>
                <label>Tijd</label>
                <input id="time" type="time" />
              </div>
            </div>

            <label>Omschrijving</label>
            <textarea id="desc" placeholder="Bijv. tandarts, etentje, controle..."></textarea>

            <div class="btns">
              <button class="primary" id="add-btn">Toevoegen</button>
              <button class="secondary" id="reset-btn">Leegmaken</button>
            </div>

            <div class="madeby">made by Rob Borghouts 2026</div>
          </div>
        </div>

        <div class="card" id="right-card">
          <h2>
            <span>Afspraken</span>
            <span id="list-subtitle" style="color:var(--muted); font-weight:800; font-size:.85rem;">komende</span>
          </h2>

          <div class="list" id="apt-list"></div>

          <div class="body">
            <div class="exportbar" id="exportbar">
              <button id="export-all">üì§ Exporteer alles (.ics)</button>
              <button id="export-tab">üì§ Exporteer tab (.ics)</button>
            </div>

            <div class="footerbar">
              <div class="small">Alles wordt lokaal opgeslagen op dit apparaat.</div>
              <button class="secondary" id="clear-all">Alles wissen</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">...</div>
  </div>

  <script>
   var STORAGE_KEY  = "afspraken_v3";
    var REMIND_KEY   = "afspraken_reminders";
    var appointments = [];

    var BDAY_KEY     = "verjaardagen_v1";
    var birthdays    = [];
    try { birthdays = JSON.parse(localStorage.getItem(BDAY_KEY)) || []; } catch(e) {}
    function saveBdays(){ try { localStorage.setItem(BDAY_KEY, JSON.stringify(birthdays)); } catch(e) {} }

    var MEM_KEY  = "herinneringen_v1";
    var memories = [];
    try { memories = JSON.parse(localStorage.getItem(MEM_KEY)) || []; } catch(e) {}
    function saveMem(){ try { localStorage.setItem(MEM_KEY, JSON.stringify(memories)); } catch(e) {} }

    try { appointments = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e) { appointments = []; }
    function saveAppointments(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appointments)); } catch(e) {} }

    function loadRemindersOn(){
      try {
        var v = localStorage.getItem(REMIND_KEY);
        if (v === null) return true;
        return v === "1";
      } catch(e) { return true; }
    }
    function saveRemindersOn(on){ try { localStorage.setItem(REMIND_KEY, on ? "1" : "0"); } catch(e) {} }

    var tabs         = Array.from(document.querySelectorAll(".tab"));
    var whoSelect    = document.getElementById("who");
    var dateInput    = document.getElementById("date");
    var timeInput    = document.getElementById("time");
    var descInput    = document.getElementById("desc");
    var addBtn       = document.getElementById("add-btn");
    var resetBtn     = document.getElementById("reset-btn");
    var aptList      = document.getElementById("apt-list");
    var exportAllBtn = document.getElementById("export-all");
    var exportTabBtn = document.getElementById("export-tab");
    var clearAllBtn  = document.getElementById("clear-all");

    var searchInput  = document.getElementById("search-input");
    var searchClear  = document.getElementById("search-clear");
    var searchCount  = document.getElementById("search-count");

    var bdaySection  = document.getElementById("bday-section");
    var bdayName     = document.getElementById("bday-name");
    var bdayDate     = document.getElementById("bday-date");
    var bdayAdd      = document.getElementById("bday-add");
    var bdayExport   = document.getElementById("bday-export");

    var memSection   = document.getElementById("mem-section");
    var memName      = document.getElementById("mem-name");
    var memType      = document.getElementById("mem-type");
    var memDate      = document.getElementById("mem-date");
    var memNote      = document.getElementById("mem-note");
    var memAdd       = document.getElementById("mem-add");
    var memExport    = document.getElementById("mem-export");

    var toast        = document.getElementById("toast");
    var exportBar    = document.getElementById("exportbar");
    var reminderToggle = document.getElementById("reminder-toggle");

    var pillToday = document.getElementById("pill-today");
    var pillWeek  = document.getElementById("pill-week");
    var pillTotal = document.getElementById("pill-total");

    var leftCard  = document.getElementById("left-card");
    var rightCard = document.getElementById("right-card");

    var activeTab   = "alle";
    var searchQuery = "";
    var remindersOn = loadRemindersOn();

    function showToast(msg){
      toast.innerHTML = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(function(){ toast.classList.remove("show"); }, 2200);
    }

    function pad2(n){ return (n<10?"0":"")+n; }

    function dateToISO(d){
      var yyyy = d.getFullYear();
      var mm = pad2(d.getMonth()+1);
      var dd = pad2(d.getDate());
      return yyyy+"-"+mm+"-"+dd;
    }

    function isoToLocalDate(iso){
      var p = String(iso||"").split("-");
      var y = parseInt(p[0],10);
      var m = parseInt(p[1],10);
      var d = parseInt(p[2],10);
      return new Date(y, m-1, d);
    }

    function escH(s){
      return String(s||"").replace(/[&<>"']/g,function(m){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
      });
    }

    function normalizeISO(iso){
      if (!iso) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
      try{
        var d = new Date(iso);
        if (isNaN(d)) return "";
        return dateToISO(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
      }catch(e){ return ""; }
    }

    function computeCounts(){
      var today = new Date();
      var todayISO = dateToISO(new Date(today.getFullYear(), today.getMonth(), today.getDate()));
      var weekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate()+7);
      var weekEndISO = dateToISO(weekEnd);

      var list = appointments.slice();
      var todayCount = 0;
      var weekCount = 0;

      list.forEach(function(a){
        var d = normalizeISO(a.date);
        if (!d) return;
        if (d === todayISO) todayCount++;
        if (d >= todayISO && d < weekEndISO) weekCount++;
      });

      pillToday.textContent = "Vandaag: " + todayCount;
      pillWeek.textContent = "Deze week: " + weekCount;
      pillTotal.textContent = "Totaal: " + list.length;
    }

    function filteredAppointments(){
      var list = appointments.slice();

      if (activeTab !== "alle"){
        list = list.filter(function(a){ return a.who === activeTab; });
      }

      if (searchQuery){
        var q = searchQuery.toLowerCase();
        list = list.filter(function(a){
          return (a.desc||"").toLowerCase().includes(q) ||
                 (a.date||"").toLowerCase().includes(q) ||
                 (a.time||"").toLowerCase().includes(q) ||
                 (a.who||"").toLowerCase().includes(q);
        });
      }

      list.sort(function(a,b){
        var da = (a.date||"") + " " + (a.time||"");
        var db = (b.date||"") + " " + (b.time||"");
        return da.localeCompare(db);
      });

      return list;
    }

    function buildICS(apts){
      var lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Rob Borghouts//Onze Agenda//NL",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH"
      ];

      apts.forEach(function(a){
        var d = normalizeISO(a.date);
        if (!d) return;
        var dt = d.replace(/-/g,"");
        var summary = (a.who==="rob"?"Rob":(a.who==="lizet"?"Lizet":"Beide")) + " - " + (a.desc||"");
        lines.push("BEGIN:VEVENT");
        lines.push("UID:apt-"+a.id+"@onze-agenda");
        lines.push("DTSTAMP:"+new Date().toISOString().replace(/[-:.]/g,"").slice(0,15)+"Z");
        if (a.time){
          var tm = a.time.replace(":","");
          lines.push("DTSTART:"+dt+"T"+tm+"00");
          lines.push("DTEND:"+dt+"T"+tm+"00");
        } else {
          lines.push("DTSTART;VALUE=DATE:"+dt);
        }
        lines.push("SUMMARY:"+summary.replace(/\n/g," ").slice(0,160));
        lines.push("END:VEVENT");
      });

      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function downloadTextFile(filename, content, mime){
      var blob = new Blob([content],{type:mime||"text/plain;charset=utf-8"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadICSFromList(list, filename){
      if (!list.length){ showToast("Geen afspraken om te exporteren"); return; }
      downloadTextFile(filename, buildICS(list), "text/calendar;charset=utf-8");
    }
   function nextBirthdayDateISO(mmdd) {
      var now = new Date();
      var y = now.getFullYear();
      var m = parseInt(mmdd.slice(0,2),10);
      var d = parseInt(mmdd.slice(3,5),10);

      var dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);

      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (dt.getTime() < today.getTime()) {
        dt = new Date(y+1, m-1, d);
        dt.setHours(0,0,0,0);
      }

      return dateToISO(dt);
    }

    function daysUntil(iso) {
      var now = new Date();
      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var dt = isoToLocalDate(iso);
      var diff = Math.round((dt.getTime() - today.getTime()) / 86400000);
      return diff;
    }

    function buildBdayICS(list) {
      var lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Rob Borghouts//Verjaardagen//NL","CALSCALE:GREGORIAN","METHOD:PUBLISH"];
      list.forEach(function(b) {
        if (!b.mmdd) return;
        var year = (new Date()).getFullYear();
        var m = b.mmdd.slice(0,2);
        var d = b.mmdd.slice(3,5);
        var dtstart = ""+year+m+d;
        lines.push(
          "BEGIN:VEVENT",
          "UID:bday-"+b.id+"@onze-agenda",
          "SUMMARY:üéÇ Verjaardag "+(b.name||""),
          "DTSTART;VALUE=DATE:"+dtstart,
          "RRULE:FREQ=YEARLY",
          "DTSTAMP:"+new Date().toISOString().replace(/[-:.]/g,"").slice(0,15)+"Z",
          "END:VEVENT"
        );
      });
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function downloadBdayICS() {
      if (!birthdays.length) { alert("Geen verjaardagen."); return; }
      var blob = new Blob([buildBdayICS(birthdays)],{type:"text/calendar;charset=utf-8"});
      var url  = URL.createObjectURL(blob);
      var a    = document.createElement("a"); a.href=url; a.download="verjaardagen.ics"; a.click();
      URL.revokeObjectURL(url);
    }

    function buildMemICS(list){
      var lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Rob Borghouts//Herinneringen//NL","CALSCALE:GREGORIAN","METHOD:PUBLISH"];
      list.forEach(function(m){
        if (!m.mmdd) return;
        var year = (new Date()).getFullYear();
        var dtstart = ""+year+m.mmdd.slice(0,2)+m.mmdd.slice(3,5);
        var title = "üïØÔ∏è "+(m.type||"Herinnering")+": "+(m.name||"");
        if (m.note) title += " - " + m.note;
        lines.push(
          "BEGIN:VEVENT",
          "UID:mem-"+m.id+"@onze-agenda",
          "SUMMARY:"+title.replace(/\n/g," ").slice(0,180),
          "DTSTART;VALUE=DATE:"+dtstart,
          "RRULE:FREQ=YEARLY",
          "DTSTAMP:"+new Date().toISOString().replace(/[-:.]/g,"").slice(0,15)+"Z",
          "END:VEVENT"
        );
      });
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function downloadMemICS(){
      if (!memories.length) { alert("Geen herinneringen."); return; }
      var blob = new Blob([buildMemICS(memories)],{type:"text/calendar;charset=utf-8"});
      var url  = URL.createObjectURL(blob);
      var a    = document.createElement("a"); a.href=url; a.download="herinneringen.ics"; a.click();
      URL.revokeObjectURL(url);
    }

    function renderBirthdays() {
      document.getElementById("count-bdays").textContent = "("+birthdays.length+")";

      var q = (searchQuery || "").trim().toLowerCase();
      var list = birthdays.slice();

      if (q) {
        list = list.filter(function(b){
          return (b.name||"").toLowerCase().includes(q);
        });
      }

      list.forEach(function(b){
        b.nextISO = nextBirthdayDateISO(b.mmdd);
        b.daysLeft = daysUntil(b.nextISO);
      });

      list.sort(function(a,b){ return a.daysLeft - b.daysLeft; });

      if (!list.length) {
        aptList.innerHTML = q
          ? '<div class="empty-state"><div class="icon">üîé</div><p>Geen verjaardagen gevonden.<br>Probeer een andere zoekterm.</p></div>'
          : '<div class="empty-state"><div class="icon">üéÇ</div><p>Geen verjaardagen.<br>Voeg er eentje toe hierboven.</p></div>';
        return;
      }

      var html = "";
      html += '<div class="section-title">Verjaardagen<span class="count-badge">'+list.length+"</span></div>";

      list.forEach(function(b){
        var whenTxt = b.nextISO ? isoToLocalDate(b.nextISO).toLocaleDateString("nl-NL",{day:"numeric",month:"long",year:"numeric"}) : "";
        var leftTxt = (b.daysLeft === 0) ? "Vandaag" : (b.daysLeft === 1 ? "Morgen" : "Over "+b.daysLeft+" dagen");

        html += '<div class="apt-card beide" style="margin-bottom:8px">'
          +'<div class="apt-icon">üéÇ</div>'
          +'<div class="apt-body">'
          +'<div class="apt-who beide">Verjaardag</div>'
          +'<div class="apt-desc">'+escH(b.name||"")+'</div>'
          +'<div class="apt-meta">'
          +'<span>üìÖ '+escH(whenTxt)+'</span>'
          +'<span>'+escH(leftTxt)+'</span>'
          +'</div></div>'
          +'<div class="apt-actions">'
          +'<button class="bday-del-btn" data-bid="'+b.id+'" title="Verwijder">üóëÔ∏è</button>'
          +'</div>'
          +'</div>';
      });

      aptList.innerHTML = html;
    }

    function renderMemories(){
      document.getElementById("count-mem").textContent = "("+memories.length+")";

      var q = (searchQuery || "").trim().toLowerCase();
      var list = memories.slice();

      if (q){
        list = list.filter(function(m){
          return (m.name||"").toLowerCase().includes(q) ||
                 (m.type||"").toLowerCase().includes(q) ||
                 (m.note||"").toLowerCase().includes(q);
        });
      }

      list.forEach(function(m){
        m.nextISO = nextBirthdayDateISO(m.mmdd);
        m.daysLeft = daysUntil(m.nextISO);
      });

      list.sort(function(a,b){ return a.daysLeft - b.daysLeft; });

      if (!list.length){
        aptList.innerHTML = q
          ? '<div class="empty-state"><div class="icon">üîé</div><p>Geen herinneringen gevonden.<br>Probeer een andere zoekterm.</p></div>'
          : '<div class="empty-state"><div class="icon">üïØÔ∏è</div><p>Geen herinneringen.<br>Voeg er eentje toe hierboven.</p></div>';
        return;
      }

      var html = "";
      html += '<div class="section-title">Herinneringen<span class="count-badge">'+list.length+"</span></div>";

      list.forEach(function(m){
        var whenTxt = m.nextISO ? isoToLocalDate(m.nextISO).toLocaleDateString("nl-NL",{day:"numeric",month:"long",year:"numeric"}) : "";
        var leftTxt = (m.daysLeft === 0) ? "Vandaag" : (m.daysLeft === 1 ? "Morgen" : "Over "+m.daysLeft+" dagen");

        var yearsTxt = "";
        if (m.year){
          var nowY = (new Date()).getFullYear();
          var yrs = nowY - m.year;
          if (yrs >= 0) yearsTxt = " , " + yrs + " jaar";
        }

        html += '<div class="apt-card beide" style="margin-bottom:8px">'
          +'<div class="apt-icon">üïØÔ∏è</div>'
          +'<div class="apt-body">'
          +'<div class="apt-who beide">'+escH(m.type||"Herinnering")+'</div>'
          +'<div class="apt-desc">'+escH(m.name||"")+'</div>'
          +'<div class="apt-meta">'
          +'<span>üìÖ '+escH(whenTxt)+'</span>'
          +'<span>'+escH(leftTxt + yearsTxt)+'</span>'
          +(m.note ? '<span>üìù '+escH(m.note)+'</span>' : '')
          +'</div></div>'
          +'<div class="apt-actions">'
          +'<button class="mem-del-btn" data-mid="'+m.id+'" title="Verwijder">üóëÔ∏è</button>'
          +'</div>'
          +'</div>';
      });

      aptList.innerHTML = html;
    }

    function updateTabCounts(){
      var all = appointments.length;
      var rob = appointments.filter(function(a){return a.who==="rob";}).length;
      var liz = appointments.filter(function(a){return a.who==="lizet";}).length;

      document.getElementById("count-alle").textContent  = "("+all+")";
      document.getElementById("count-rob").textContent   = "("+rob+")";
      document.getElementById("count-lizet").textContent = "("+liz+")";
      document.getElementById("count-bdays").textContent = "("+birthdays.length+")";
      document.getElementById("count-mem").textContent   = "("+memories.length+")";
    }

    function render(){
      updateTabCounts();
      computeCounts();

      var listSubtitle = document.getElementById("list-subtitle");

      if (activeTab === "verjaardagen") {
        bdaySection.style.display = "block";
        memSection.style.display = "none";
        exportBar.style.display = "none";

        leftCard.style.display = "none";
        rightCard.style.gridColumn = "1 / -1";
        window.scrollTo({ top: 0, behavior: "smooth" });

        renderBirthdays();
        return;
      }

      if (activeTab === "herinneringen") {
        bdaySection.style.display = "none";
        memSection.style.display = "block";
        exportBar.style.display = "none";

        leftCard.style.display = "none";
        rightCard.style.gridColumn = "1 / -1";
        window.scrollTo({ top: 0, behavior: "smooth" });

        renderMemories();
        return;
      }

      bdaySection.style.display = "none";
      memSection.style.display = "none";
      exportBar.style.display = "";

      leftCard.style.display = "";
      rightCard.style.gridColumn = "";

      var list = filteredAppointments();

      if (searchQuery){
        searchCount.innerHTML = '<div class="pill">Zoekresultaten: '+list.length+'</div>';
      } else {
        searchCount.innerHTML = "";
      }

      if (!list.length){
        aptList.innerHTML = searchQuery
          ? '<div class="empty-state"><div class="icon">üîé</div><p>Geen afspraken gevonden.<br>Probeer een andere zoekterm.</p></div>'
          : '<div class="empty-state"><div class="icon">üìÖ</div><p>Geen afspraken.<br>Voeg er eentje toe links.</p></div>';
        listSubtitle.textContent = searchQuery ? "gevonden" : "komende";
        return;
      }

      listSubtitle.textContent = searchQuery ? "gevonden" : "komende";

      var html = "";
      html += '<div class="section-title">Afspraken<span class="count-badge">'+list.length+"</span></div>";

      list.forEach(function(a){
        var whoLabel = a.who==="rob" ? "Rob" : (a.who==="lizet" ? "Lizet" : "Beide");
        var cls = a.who || "beide";
        var d = normalizeISO(a.date);
        var dtTxt = "";
        if (d){
          dtTxt = isoToLocalDate(d).toLocaleDateString("nl-NL",{day:"numeric",month:"long",year:"numeric"});
        }
        var tmTxt = a.time ? a.time : "Hele dag";

        html += '<div class="apt-card '+cls+'" data-id="'+a.id+'">'
          +'<div class="apt-icon">üìå</div>'
          +'<div class="apt-body">'
          +'<div class="apt-who '+cls+'">'+whoLabel+'</div>'
          +'<div class="apt-desc">'+escH(a.desc||"")+'</div>'
          +'<div class="apt-meta">'
          +'<span>üìÖ '+escH(dtTxt)+'</span>'
          +'<span>‚è∞ '+escH(tmTxt)+'</span>'
          +'</div></div>'
          +'<div class="apt-actions">'
          +'<button class="apt-del-btn" data-id="'+a.id+'" title="Verwijder">üóëÔ∏è</button>'
          +'</div>'
          +'</div>';
      });

      aptList.innerHTML = html;
    }

    function resetForm(){
      whoSelect.value = "beide";
      var now = new Date();
      dateInput.value = dateToISO(now);
      timeInput.value = "";
      descInput.value = "";
    }

    function ensureDefaultDate(){
      if (!dateInput.value){
        dateInput.value = dateToISO(new Date());
      }
    }
   function scheduleNotification(a){
      if (!remindersOn) return;
      if (!("Notification" in window)) return;

      var d = normalizeISO(a.date);
      if (!d) return;

      var hasTime = !!a.time;
      var base = new Date(d + (hasTime ? "T"+a.time+":00" : "T09:00:00"));
      var when = base.getTime() - (15 * 60 * 1000);
      var now = Date.now();
      if (when <= now) return;

      var delay = when - now;
      setTimeout(function(){
        try{
          new Notification("Afspraak", { body: (a.desc||"") + " ("+(a.who||"beide")+")" });
        }catch(e){}
      }, delay);
    }

    function requestNotificationPermission(){
      if (!("Notification" in window)) return;
      if (Notification.permission === "default"){
        Notification.requestPermission().then(function(){});
      }
    }

    function applyReminderToggleUI(){
      if (remindersOn){
        reminderToggle.classList.remove("off");
      } else {
        reminderToggle.classList.add("off");
      }
    }

    tabs.forEach(function(btn){
      btn.addEventListener("click", function(){
        tabs.forEach(function(b){ b.classList.remove("active"); });
        btn.classList.add("active");
        activeTab = btn.getAttribute("data-tab");
        render();
      });
    });

    searchInput.addEventListener("input", function(){
      searchQuery = searchInput.value || "";
      render();
    });

    searchClear.addEventListener("click", function(){
      searchInput.value = "";
      searchQuery = "";
      render();
    });

    addBtn.addEventListener("click", function(){
      ensureDefaultDate();
      var a = {
        id: Date.now(),
        who: whoSelect.value,
        date: dateInput.value,
        time: timeInput.value,
        desc: (descInput.value||"").trim() || "Afspraak",
        createdAt: new Date().toISOString()
      };
      appointments.push(a);
      saveAppointments();
      if (remindersOn) scheduleNotification(a);
      showToast("‚úÖ Afspraak toegevoegd");
      descInput.value = "";
      timeInput.value = "";
      render();
    });

    resetBtn.addEventListener("click", function(){
      resetForm();
      showToast("Formulier leeg");
    });

    clearAllBtn.addEventListener("click", function(){
      if (!confirm("Alles wissen?")) return;
      appointments = [];
      saveAppointments();
      showToast("Alles gewist");
      render();
    });

    exportAllBtn.addEventListener("click", function(){
      downloadICSFromList(appointments.slice(), "onze-agenda.ics");
    });

    exportTabBtn.addEventListener("click", function(){
      var list = filteredAppointments();
      var name = activeTab === "alle" ? "alle" : activeTab;
      downloadICSFromList(list, "onze-agenda-"+name+".ics");
    });

    aptList.addEventListener("click", function(e){
      var del = e.target.closest(".apt-del-btn");
      var bdel = e.target.closest(".bday-del-btn");
      var mdel = e.target.closest(".mem-del-btn");

      if (mdel && mdel.dataset.mid){
        var mid = parseInt(mdel.dataset.mid,10);
        memories = memories.filter(function(m){ return m.id !== mid; });
        saveMem();
        showToast("üïØÔ∏è Herinnering verwijderd");
        render();
        return;
      }

      if (bdel && bdel.dataset.bid){
        var bid = parseInt(bdel.dataset.bid,10);
        birthdays = birthdays.filter(function(b){ return b.id !== bid; });
        saveBdays();
        showToast("üéÇ Verjaardag verwijderd");
        render();
        return;
      }

      if (del && del.dataset.id){
        var id = parseInt(del.dataset.id,10);
        appointments = appointments.filter(function(a){ return a.id !== id; });
        saveAppointments();
        showToast("üóëÔ∏è Verwijderd");
        render();
      }
    });

    reminderToggle.addEventListener("click", function(){
      remindersOn = !remindersOn;
      saveRemindersOn(remindersOn);
      applyReminderToggleUI();
      if (remindersOn){
        requestNotificationPermission();
        appointments.forEach(scheduleNotification);
        showToast("Herinneringen aan");
      } else {
        showToast("Herinneringen uit");
      }
    });

    bdayAdd.addEventListener("click", function(){
      var name = (bdayName.value || "").trim();
      var date = (bdayDate.value || "").trim();
      if (!name || !date) { showToast("Vul naam en datum in"); return; }

      var mmdd = date.slice(5,7)+"-"+date.slice(8,10);
      var item = { id: Date.now(), name: name, mmdd: mmdd, createdAt: new Date().toISOString() };
      birthdays.push(item);
      saveBdays();
      bdayName.value = "";
      bdayDate.value = "";
      showToast("üéÇ Verjaardag toegevoegd");
      render();
    });

    bdayExport.addEventListener("click", function(){
      downloadBdayICS();
    });

    memAdd.addEventListener("click", function(){
      var name = (memName.value || "").trim();
      var date = (memDate.value || "").trim();
      var type = (memType.value || "Herinnering").trim();
      var note = (memNote.value || "").trim();

      if (!name || !date) { showToast("Vul naam en datum in"); return; }

      var mmdd = date.slice(5,7)+"-"+date.slice(8,10);
      var year = parseInt(date.slice(0,4),10);

      memories.push({ id: Date.now(), name:name, type:type, note:note, mmdd:mmdd, year:year, createdAt:new Date().toISOString() });
      saveMem();

      memName.value = "";
      memDate.value = "";
      memNote.value = "";
      showToast("üïØÔ∏è Herinnering toegevoegd");
      render();
    });

    memExport.addEventListener("click", function(){
      downloadMemICS();
    });
   function applyMobileFixForMemTabs(){
      try{
        var isMemTab = (activeTab === "verjaardagen" || activeTab === "herinneringen");
        if (isMemTab){
          leftCard.style.display = "none";
          rightCard.style.gridColumn = "1 / -1";
        } else {
          leftCard.style.display = "";
          rightCard.style.gridColumn = "";
        }
      } catch(e){}
    }

    (function init(){
      applyReminderToggleUI();
      resetForm();
      ensureDefaultDate();
      applyMobileFixForMemTabs();

      if (remindersOn){
        requestNotificationPermission();
        appointments.forEach(scheduleNotification);
      }

      render();
    })();
  </script>
</body>
</html>
